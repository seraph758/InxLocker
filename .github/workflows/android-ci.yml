name: Android CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses

      - name: Install Android SDK components
        run: |
          sdkmanager "platform-tools" "platforms;android-36" "build-tools;36.0.0"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build release APK
        run: ./gradlew --no-daemon clean assembleRelease

      - name: 准备密钥库
        if: ${{ success() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        env:
          SIGNING_KEYSTORE_BASE64: ${{ secrets.SIGNING_KEYSTORE_BASE64 }}
        run: |
          set -euo pipefail
          if [ -z "${SIGNING_KEYSTORE_BASE64:-}" ]; then
            echo "未配置签名所需 Secrets，跳过生成密钥库文件";
            exit 0;
          fi
          echo "$SIGNING_KEYSTORE_BASE64" | base64 -d > keystore.jks
          ls -l keystore.jks

      - name: 对齐并签名 APK
        if: ${{ success() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        run: |
          set -euo pipefail
          BUILD_TOOLS_DIR="${ANDROID_HOME:-$ANDROID_SDK_ROOT}/build-tools/36.0.0"
          ZIPALIGN="$BUILD_TOOLS_DIR/zipalign"
          APKSIGNER="$BUILD_TOOLS_DIR/apksigner"
          if [ -z "${SIGNING_KEY_ALIAS:-}" ] || [ -z "${SIGNING_KEY_PASSWORD:-}" ] || [ -z "${SIGNING_STORE_PASSWORD:-}" ] || [ ! -f keystore.jks ]; then
            echo "未配置签名所需 Secrets，跳过签名";
            exit 0;
          fi
          ORIG_APK=$(ls app/build/outputs/apk/release/*.apk | head -n 1)
          echo "Release APK: $ORIG_APK"
          ALIGNED_APK="${ORIG_APK%.apk}-aligned.apk"
          # zipalign (if already aligned, fall back to copy)
          if [ -x "$ZIPALIGN" ]; then
            "$ZIPALIGN" -p -f 4 "$ORIG_APK" "$ALIGNED_APK" || cp "$ORIG_APK" "$ALIGNED_APK"
          else
            cp "$ORIG_APK" "$ALIGNED_APK"
          fi
          # replace original with aligned to keep original filename
          mv -f "$ALIGNED_APK" "$ORIG_APK"
          # apksigner
          "$APKSIGNER" sign \
            --ks keystore.jks \
            --ks-key-alias "$SIGNING_KEY_ALIAS" \
            --ks-pass pass:"$SIGNING_STORE_PASSWORD" \
            --key-pass pass:"$SIGNING_KEY_PASSWORD" \
            "$ORIG_APK"
          "$APKSIGNER" verify --print-certs "$ORIG_APK"
          echo "Release APK: $ORIG_APK"
          sha256sum "$ORIG_APK" || true

      - name: 验证 APK（非 fork 运行）
        if: ${{ success() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        run: |
          BUILD_TOOLS_DIR="${ANDROID_HOME:-$ANDROID_SDK_ROOT}/build-tools/36.0.0"
          APKSIGNER="$BUILD_TOOLS_DIR/apksigner"
          FILE=$(ls app/build/outputs/apk/release/*.apk 2>/dev/null | head -n 1 || true)
          if [ ! -f "$FILE" ]; then
            echo "未找到 Release APK。" >&2
            exit 1
          fi
          # 验证 APK 签名；非零退出表示验证失败
          "$APKSIGNER" verify --print-certs "$FILE"

      - name: Upload APK artifact
        if: ${{ success() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        uses: actions/upload-artifact@v4
        with:
          name: InxLocker-apk
          path: app/build/outputs/apk/release/*.apk
          if-no-files-found: error

      - name: Notify Telegram (success)
        if: ${{ success() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "未配置 Telegram Secrets，跳过消息通知";
            exit 0;
          fi
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          TEXT="✅ 构建成功\n仓库: ${GITHUB_REPOSITORY}\n分支: ${GITHUB_REF_NAME}\n提交: ${SHORT_SHA}\n触发者: ${GITHUB_ACTOR}\n运行: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" -d parse_mode="Markdown" -d text="$TEXT"

      - name: Send APK to Telegram (optional)
        if: ${{ success() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        continue-on-error: true
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "未配置 Telegram Secrets，跳过发送 APK";
            exit 0;
          fi
          FILE=$(ls app/build/outputs/apk/release/*.apk 2>/dev/null | head -n 1 || true)
          [ -f "$FILE" ] || exit 0
          CAPTION="InxLocker APK: $(basename "$FILE")"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
            -F chat_id="${TELEGRAM_CHAT_ID}" \
            -F document="@${FILE}" \
            -F caption="$CAPTION"

      - name: Notify Telegram (failure)
        if: ${{ failure() && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false) }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN:-}" ] || [ -z "${TELEGRAM_CHAT_ID:-}" ]; then
            echo "未配置 Telegram Secrets，跳过失败通知";
            exit 0;
          fi
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          TEXT="❌ 构建失败\n仓库: ${GITHUB_REPOSITORY}\n分支: ${GITHUB_REF_NAME}\n提交: ${SHORT_SHA}\n触发者: ${GITHUB_ACTOR}\n运行: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" -d parse_mode="Markdown" -d text="$TEXT"
